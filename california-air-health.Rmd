---
title: "Something Clever"
author: "Ruthe Huang, Xinye Li, Emily Scott"
date: "December 19, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F, fig.align = "center")
```

## Motivation and Overview

Wildfires are a natural, annual occurrence in California. However, climate change has helped California's wildfires more intense, with the warm and dry conditions creating ideal conditions for wildfire. According to the Environmental Protection Agency, the state of California is becoming warmer as a whole; preceding both 2017 and 2018 wildfires were some of the state's highest temperatures in history.

Predictably, large fires have become more common in California, as seen in the chart below. Each bar represents a single fire, and the bar height represents the size of areas burned, in acres.

![](https://www.gannett-cdn.com/experiments/usatoday/responsive/2018/ca-wildfires/img/cal-fires-1970-2017.svg)

Fires now tend to be associated with more human risk due to urban expansion into high-risk fire zones. California's population increasingly tends to live in proximity to high-risk fire corridors; as a result, wildfires more frequently devastate settled areas. The number of properties at risk of wildfire threat is estimated by Villanova University to be nearly 7 million, a more than 1000% increase in the number of homes and developed land in areas prone to wildfires since 1940. California's 2018 Camp Fire completely destroyed Paradise, CA, the second-largest city in Butte County with a population of about 26,682. A 2017 Verisk risk analysis puts 15% -- or over 2 million -- of California's homes in high or extremely high wildfire risk zones and another 12% in moderate risk areas; this means more than a quarter of the state's homes are at moderate to extremely high risk of being damaged in a wildfire.

The extent of risk undeniably poses a huge task for California firefighters. Historically, Southern California firefighters were able to depend on help from Northern California partners, since Northern California would have already started to see rainfall or even snow. However with statewide climate change, both northern and southern California fires continue to be disastrous and necessitate abundant resources.

## Related Work

A 2006 study by Dominici, Peng, and Bell showed that short-term exposure to $\text{PM}_{2.5}$ increases the risk for hospital admission for cardiovascular and respiratory diseases. Specifically, there was a short-term increase in hospital admission rates associated with $\text{PM}_{2.5}$ 

## Initial Questions

## Data

## Exploratory Data Analysis

## Data Analysis

## Results and Summary

```{r Read in data, eval = F}
rm(list = ls())
library(tidyverse); library(lubridate); library(stringr); library(rgdal)

# read in 2010-2017 California air quality data
pm25 <- read_csv("data/pm25_annual-days-above-nat-24-hr-stnd.csv", na = "*") %>% group_by(county) %>% summarize(pm2010 = mean(pm2010, na.rm = T), pm2011 = mean(pm2011, na.rm = T), pm2012 = mean(pm2012, na.rm = T), pm2013 = mean(pm2013, na.rm = T), pm2014 = mean(pm2014, na.rm = T), pm2015 = mean(pm2015, na.rm = T), pm2016 = mean(pm2016, na.rm = T), pm2017 = mean(pm2017, na.rm = T)) %>% gather(year, pm25, pm2010:pm2017) %>% mutate(year = as.numeric(str_sub(year, 3, 6))) %>% arrange(county)
head(pm25)

demo <- read_csv("data/age_edu_race.csv")[ , -1] %>% group_by(Geography, Year) %>% filter(bachelor_perc <= 100) %>% summarize(age60_perc = mean(age60_perc, na.rm = T), bachelor_perc = mean(bachelor_perc, na.rm = T), est.white.percent = mean(est.white.percent, na.rm = T), est.black.percent = mean(est.black.percent, na.rm = T)) %>% ungroup() %>% mutate(Geography = str_sub(Geography, 1, -20)) %>% rename(county = Geography, year = Year)
head(demo)

phosp <- read_csv("data/ca-oshpd-preventablehospitalizations-county-2005-2017.csv")
ph_early <- phosp %>% filter(Year < 2016) %>% group_by(County, Year) %>% select(Year, County, PQIDescription, ObsRate_ICD9) %>% spread(PQIDescription, value = ObsRate_ICD9) %>% rename(diabetes_st = "Diabetes Short-term Complications", perf_appendix = "Perforated Appendix", diabetes_lt = "Diabetes Long-term Complications", asthma_older = "COPD or Asthma in Older Adults (Age 40+)", hypertension = "Hypertension", heart_fail = "Heart Failure", dehydration = "Dehydration", pneumonia = "Community-Acquired Pneumonia", uti = "Urinary Tract Infection", angina = "Angina without Procedure", diabetes_uc = "Uncontrolled Diabetes", asthma_young = "Asthma in Younger Adults (Age 18-39)", amputation_diab = "Lower-Extremity Amputation (Diabetes)", pq_overall = "Prevention Quality Overall Composite", pq_acute = "Prevention Quality Acute Composite", pq_chronic = "Prevention Quality Chronic Composite") %>% mutate(pq_diabetes = NA)

ph_late <- phosp %>% filter(Year >= 2016) %>% group_by(County, Year) %>% select(Year, County, PQIDescription, ObsRate_ICD10) %>% spread(PQIDescription, value = ObsRate_ICD10) %>% rename(asthma_older = "COPD or Asthma in Older Adults (Age 40+)", diabetes_st = "Diabetes Short-term Complications", perf_appendix = "Perforated Appendix", diabetes_lt = "Diabetes Long-term Complications", hypertension = "Hypertension", heart_fail = "Heart Failure", dehydration = "Dehydration", pneumonia = "Community-Acquired Pneumonia", uti = "Urinary Tract Infection", diabetes_uc = "Uncontrolled Diabetes", asthma_young = "Asthma in Younger Adults (Age 18-39)", amputation_diab = "Lower-Extremity Amputation (Diabetes)", pq_overall = "Prevention Quality Overall Composite", pq_acute = "Prevention Quality Acute Composite", pq_chronic = "Prevention Quality Chronic Composite", pq_diabetes = "Prevention Quality Diabetes Composite") %>% mutate(angina = NA)

phosp <- rbind(ph_early, ph_late) %>% arrange(County) %>% rename(county = County, year = Year)

dat <- demo %>% left_join(pm25, by = c("county", "year")) %>% left_join(phosp, by = c("county", "year")) %>% mutate(region = NA, region = replace(region, county %in% c("Del Norte", "Humboldt", "Mendocino", "Lake", "Siskiyou", "Trinity", "Shasta", "Tehema", "Butte", "Yuba",
"Sacramento", "Modoc", "Lassen"), "northern"), region = replace(region, county %in% c("Sonoma", "Marin", "Solano", "Napa", "Yolo", "Contra Costa", "Alameda", "San Mateo", "Santa Clara", "Santa Cruz", "San Benito", "Monterey", "San Luis Obispo", "Santa Barbara", "Ventura", "Orange", "San Diego", "Riverside", "Sierra", "Nevada", "Placer", "El Dorado", "Amador", "Mono"), "coastal"), region = replace(region, county %in% c("Alpine", "Calaveras", "Tuolumne", "Mariposa", "Inyo"), "motherlode"), region = replace(region, county %in% c("Glenn", "Colusa", "Sutter", "San Joaquin", "Stanislaus", "Merced", "Madera", "Fresno", "Kings", "Tulare", "Kern", "Los Angeles", "San Bernardino"), "farm"), region = replace(region, county == "San Francisco", "sanfrancisco"), region = replace(region, county == "Imperial", "imperial"))
# save(dat, file = "data/dat.R")
rm(list = setdiff(ls(), "dat"))
```

```{r CA visualizations}
rm(list = ls())
library(tidyverse); library(lubridate); library(stringr); library(rgdal)

load("data/dat.Rdata")
cali <- readOGR(dsn = "data/CA_Counties", layer = "CA_Counties_TIGER2016")
cali$NAME <- as.character(cali$NAME)
# plot(cali)

caplot <- function(yr, var, cutoffs = NULL) #year: numeric input, var: character input
{
  df <- dat %>% filter(year == yr) %>% select(county, var)
  map <- merge(cali, df, by.x = "NAME", by.y = "county", all.x = T)
  if (length(cutoffs) == 0)
  {
    brks <- quantile(map@data[ , var], seq(0, 1, by = 0.2), na.rm = T)
    mycols <- c("rosybrown1", "palevioletred1", "deeppink1", "magenta3", "purple4")
  } else {
    brks <- cutoffs
    mycols <- c("cornsilk1", "goldenrod1", "darkorange", "firebrick2", "darkred")
  }
  cols <- as.character(cut(map@data[ , var], breaks = brks, labels = mycols))
  
  plot(map, col = "grey77", border = NA, main = yr, cex.main = 2)
  plot(map, col = cols, add = T, border = NA)
}


pmplot <- function(yr) # special function for PM 2.5 plots
{
  df <- dat %>% filter(year == yr) %>% select(county, pm25)
  map <- merge(cali, df, by.x = "NAME", by.y = "county", all.x = T)
  cols <- as.character(cut(map@data[ , "pm25"], breaks = c(0, 3, 6, 10, 20, 100), include.lowest = T, labels = c("darkseagreen1", "mediumspringgreen", "darkturquoise", "dodgerblue2", "navy")))
  
  plot(map, col = "grey77", border = NA, main = yr, cex.main = 2)
  plot(map, col = cols, add = T, border = NA)
  # legend(x = -12890659, y = 4927837, legend = levels(cut(map@data[ , "pm25"], breaks = c(0, 3, 6, 10, 20, 100), include.lowest = T)), fill = c("darkseagreen1", "mediumspringgreen", "darkturquoise", "dodgerblue2", "navy"), cex = 1)
}

bigplot <- function(var, cut = NULL, omit = F)
{
  if (length(cut) == 0)
  {
    par(oma = c(4, 0, 0, 0), mar = c(0.5, 0.5, 1.5, 0.5), mfrow = c(2, 4))
    caplot(2010, var)
    caplot(2011, var)
    caplot(2012, var)
    caplot(2013, var)
    caplot(2014, var)
    caplot(2015, var)
    if (omit == F)
    {
      caplot(2016, var)
      caplot(2017, var)
    }
    par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
    plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
    legend("bottom", legend = c("[0-20th percentile]", "(20-40th percentile]", "(40-60th percentile]", "(60-80th percentile]", "(80-100th percentile]"), fill = c("rosybrown1", "palevioletred1", "deeppink1", "magenta3", "purple4"), xpd = TRUE, horiz = TRUE, inset = c(0, 0), bty = "n", cex = 2)
  } else {
    par(oma = c(4, 0, 0, 0), mar = c(0.5, 0.5, 1.5, 0.5), mfrow = c(2, 4))
    caplot(2010, var, cutoffs = cut)
    caplot(2011, var, cutoffs = cut)
    caplot(2012, var, cutoffs = cut)
    caplot(2013, var, cutoffs = cut)
    caplot(2014, var, cutoffs = cut)
    caplot(2015, var, cutoffs = cut)
    caplot(2016, var, cutoffs = cut)
    caplot(2017, var, cutoffs = cut)
    par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
    plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
    legend("bottom", legend = levels(cut(unlist(dat[ , var]), breaks = cut, include.lowest = T)), fill = c("cornsilk1", "goldenrod1", "darkorange", "firebrick2", "darkred"), xpd = TRUE, horiz = TRUE, inset = c(0, 0), bty = "n", cex = 2)
  }
}
```

## Days Over National $\text{PM}_{2.5}$ Standard by County Over Time

```{r, fig.height = 9, fig.width = 14}
par(oma = c(4, 0, 0, 0), mar = c(0.5, 0.5, 1.5, 0.5), mfrow = c(2, 4))
pmplot(2010)
pmplot(2011)
pmplot(2012)
pmplot(2013)
pmplot(2014)
pmplot(2015)
pmplot(2016)
pmplot(2017)
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
legend("bottom", legend = levels(cut(dat$pm25, breaks = c(0, 5, 10, 20, 30, 100), include.lowest = T)), fill = c("darkseagreen1", "mediumspringgreen", "darkturquoise", "dodgerblue2", "navy"), xpd = TRUE, horiz = TRUE, inset = c(0, 
    0), bty = "n", cex = 2)
```


## Health Outcomes Over Time

### Angina
```{r, fig.height = 9, fig.width = 14, echo = F}
bigplot("angina", cut = c(0, 10, 20, 30, 45, 65))
bigplot("angina", omit = T)
```

*No `angina` data for 2016 and 2017

### Asthma (in Younger Adults)
```{r, fig.height = 9, fig.width = 14, echo = F}
bigplot("asthma_young", cut = c(0, 10, 20, 30, 45, 125))
bigplot("asthma_young")
```

### Asthma/COPD (in Older Adults)
```{r, fig.height = 9, fig.width = 14, echo = F}
bigplot("asthma_older", cut = c(100, 250, 400, 600, 800, 1000))
bigplot("asthma_older")
```

### Pneumonia
```{r, fig.height = 9, fig.width = 14, echo = F}
bigplot("pneumonia", cut = c(50, 100, 200, 300, 400, 550))
bigplot("pneumonia")
```

### Dehydration
```{r, fig.height = 9, fig.width = 14, echo = F}
bigplot("dehydration", cut = c(30, 80, 100, 150, 200, 320))
bigplot("dehydration")
```

### Diabetes (Short-Term Complications)
```{r, fig.height = 9, fig.width = 14, echo = F}
bigplot("diabetes_st", cut = c(15, 45, 75, 100, 120, 150))
bigplot("diabetes_st")
```

### Diabetes (Long-Term Complications)
```{r, fig.height = 9, fig.width = 14, echo = F}
bigplot("diabetes_lt", cut = c(20, 50, 80, 100, 150, 230))
bigplot("diabetes_lt")
```

### Diabetes (Uncontrolled)
```{r, fig.height = 9, fig.width = 14, echo = F}
bigplot("diabetes_uc", cut = c(0, 5, 15, 30, 60, 100))
bigplot("diabetes_uc")
```

### Amputation (from Diabetes)
```{r, fig.height = 9, fig.width = 14, echo = F}
bigplot("amputation_diab", cut = c(0, 10, 20, 30, 45, 65))
bigplot("amputation_diab")
```

### Heart Failure
```{r, fig.height = 9, fig.width = 14, echo = F}
bigplot("heart_fail", cut = c(120, 200, 300, 400, 500, 600))
bigplot("heart_fail")
```

### Hypertension
```{r, fig.height = 9, fig.width = 14, echo = F}
bigplot("hypertension", cut = c(0, 10, 25, 40, 60, 120))
bigplot("hypertension")
```

### Perforated Appendix
```{r, fig.height = 9, fig.width = 14, echo = F}
bigplot("perf_appendix", cut = c(15, 35, 50, 100, 500, 700))
bigplot("perf_appendix")
```

*Why such a high increase in 2016-2017? Maybe data collection different?*

## UTI
```{r, fig.height = 9, fig.width = 14, echo = F}
bigplot("uti", cut = c(35, 100, 125, 150, 200, 270))
bigplot("uti")
```

#manipulating Ruthe's data for ST modeling_XL
```{r, eval = F}
library("SpatioTemporal")
library("sp")

#latitude and longitude
loc = cali@data[,c(5,6,ncol(cali@data)-1,ncol(cali@data))]
loc$NAME = as.character(loc$NAME)
names(loc)[1] = "county"
loc$NAMELSAD = as.character(loc$NAMELSAD)

#xy coordinates using WGS84
#source: https://rpubs.com/dasaptaerwin/19879
xy <- as.data.frame(loc[,c(3,4)])
xy <- as.data.frame(apply(xy,2,function(x){as.numeric(as.character(x))}))
cord.dec = SpatialPoints(cbind(xy$INTPTLON,-xy$INTPTLAT), 
                         proj4string=CRS("+proj=longlat"))
coord <- as.data.frame(spTransform(cord.dec, CRS("+init=epsg:32748")))

#combine latlong and coordinates
loc.all <- data.frame(loc,x = coord$coords.x1, y = coord$coords.x2)

#merge; county as a factor
datnew = left_join(dat,loc.all,by = "county") %>% 
  mutate(ID = factor(county)) %>%
  rename(lat = INTPTLAT, long = INTPTLON)

#outcome data for all categories
outcome_data <- datnew %>%  
  select(-age60_perc,-bachelor_perc,
         -est.white.percent,-est.black.percent,-pm25)

#Let's say we pick dehydration as an outcome
#dehydration only, wide format
#matrix
outcome_dehy <- outcome_data %>% select(ID,year, dehydration) %>%
  spread(key = ID,value = dehydration)

outcome_dehydration <- as.matrix(outcome_dehy[,-1],nrow = 8)
rownames(outcome_dehydration) = c(2010,2011,2012,2013,2014,2015,2016,2017)
colnames(outcome_dehydration) = unique(datnew$county)

#convarites (non-time-varying): I chose 2015 (this may change later)
#data.frame
covariate <- datnew %>% filter(year == 2015)  %>%
  select(ID,x,y,lat,long,age60_perc,bachelor_perc,
         est.white.percent,est.black.percent) %>%
  mutate(type = factor(rep(1,n())))

#check covaraite data is ok
#stCheckCovars(covariate, ID.unique = character(0)) #ok

#time-varying covariate: pm25
#matrix
stcov = datnew %>% select(year,ID,pm25) %>% spread(key = ID,value = pm25)
stcov <- as.matrix(stcov[,-1],nrow = 8)
rownames(stcov) = c(2010,2011,2012,2013,2014,2015,2016,2017)
colnames(stcov) = unique(datnew$county)

#list to create STdata object
st_dehy <- list(obs = outcome_dehydration, X = covariate,
               stcov = stcov)

#STdata Object!
st_dehy_obj <- createSTdata(st_dehy$obs, st_dehy$X, 
                            SpatioTemporal = list(st_pm2.5 = stcov))
# plot(st_dehy_obj,"loc")
# print(st_dehy_obj)

#try to create a STmodel: not working
LUR <- list(~est.black.percent + age60_perc + bachelor_perc)
ST <- "pm25"
locations <- list(coords = c("x","y"), long.lat = c("long", "lat"),others = "type")
cov.beta <- list(covf = "exp", nugget = FALSE)
cov.nu <- list(covf = "exp", nugget = ~type, random.effect = FALSE)
createSTmodel(st_dehy_obj, LUR = LUR, ST = ST, cov.beta = cov.beta, 
              cov.nu = cov.nu, locations = locations)


```








